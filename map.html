<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AidTracker Map</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body { height:100%; margin:0; font-family: 'Poppins', sans-serif; }
body {
  background: linear-gradient(135deg, #0a1636 70%, #d4af37 30%);
  color: white;
}
#map { height:100vh; width:100%; }

/* Pulsing user marker */
.pulse {
  width:16px; height:16px; background:#4d67fc; border:2px solid #fff; border-radius:50%;
  box-shadow:0 0 12px rgba(77, 115, 252, 0.8); position:relative;
}
.pulse::after {
  content:""; position:absolute; top:50%; left:50%; width:24px; height:24px; border-radius:50%;
  background:rgba(252,211,77,0.3); transform:translate(-50%,-50%);
  animation:pulse 1.5s infinite ease-out;
}
@keyframes pulse {
  0%{transform:translate(-50%,-50%) scale(0.8);opacity:0.8;}
  70%{transform:translate(-50%,-50%) scale(2);opacity:0;}
  100%{transform:translate(-50%,-50%) scale(0.8);opacity:0;}
}
.header button {
  background: #d4af37;
  color: #0a1636;
  padding: 4px 12px;
  border-radius: 6px;
  font-weight: bold;
  transition: all 0.3s ease;
}

.header button:hover {
  background: #f2cb61;
  transform: scale(1.05);
}

/* Floating buttons */
.map-button {
  position: fixed;
  bottom: 20px;
  padding: 12px 20px;
  background: #0a1636;
  color: #fcd34d;
  border: none;
  border-radius: 30px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.4);
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
  z-index: 1000;
}
.map-button:hover { background: #16224d; color: #ffe066; }
#reportBtn { left:50%; transform:translateX(-50%); }
#pinpointBtn { right:20px; display:flex; align-items:center; gap:6px; }
#pinpointBtn img { width:18px; height:18px; filter: invert(95%) sepia(50%) saturate(600%) hue-rotate(190deg); }

/* Overlay popup styles */
.alert-overlay {
  position: fixed; top:0; left:0; width:100%; height:100%;
  background-color: rgba(10,22,54,0.9);
  display:flex; justify-content:center; align-items:center;
  z-index: 2000;
}
.alert-box {
  background: rgba(252,211,77,0.1); color: #fff;
  padding:20px; border-radius:10px;
  text-align:center; width:90%; max-width:400px;
  border: 2px solid #fcd34d;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
}
.alert-box button {
  padding: 8px 18px;
  border-radius: 6px;
  border: none;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
}
.alert-box button:hover { opacity: 0.85; }
.hidden { display:none; }

/* Fullscreen camera overlay */
#cameraOverlay {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background-color: rgba(10,22,54,0.95);
  justify-content: center;
  align-items: center;
  flex-direction: column;
  z-index: 3000;
}

#cameraOverlay video {
  width: 100%;
  height: auto;
  max-height: 90%;
  border-radius: 10px;
}

#cameraOverlay button {
  margin-top: 15px;
  padding: 12px 25px;
  font-size: 18px;
  cursor: pointer;
  border-radius: 6px;
  border: none;
  color: #0a1636;
  font-weight: bold;
}
#captureBtn { background-color: #fcd34d; }
#closeCameraBtn { background-color: #e63946; color:white; }
video, canvas { width:100%; max-width:350px; border-radius:10px; margin-top:10px; }
input[type="file"] { margin:10px 0; }
</style>
</head>

<body>
  <div class="header">
<button onclick="goBack()"> ‚Üê </button></div>
<h2 style="text-align:center; margin:10px;">AidTracker Map</h2>
<div id="map"></div>

<!-- Floating buttons -->
<button id="reportBtn" class="map-button" onclick="showPenaltyPopup()">Report</button>
<button id="pinpointBtn" class="map-button" onclick="startPinpoint()">
  <img src="https://cdn-icons-png.flaticon.com/512/684/684908.png" alt="pin icon">
</button>

<!-- Penal Code Warning Popup -->
<div class="alert-overlay hidden" id="penaltyPopup">
  <div class="alert-box">
    <h2>Fake Reporting Warning</h2>
    <p>
      Under <strong>Republic Act No. 10175</strong> (Cybercrime Prevention Act) and related laws, 
      filing a <strong>false emergency report</strong> is punishable by fines and/or imprisonment. 
      Please ensure that all information you provide is accurate.
    </p>
    <div style="margin-top:15px;">
      <button onclick="hidePenaltyPopup()" style="background:#e63946;color:white;">Cancel</button>
      <button onclick="continueToReport()" style="background:#fcd34d;">Continue</button>
    </div>
  </div>
</div>

<!-- Report Submission Popup -->
<div class="alert-overlay hidden" id="reportPopup">
  <div class="alert-box">
    <h2>Submit Emergency Report</h2>
    <p>You may attach or capture a photo of the incident.</p>

    <input type="file" id="incidentPhoto" accept="image/*"><br>
    <button onclick="openCamera()" style="background:#fcd34d;color:#0a1636;">üì∏ Open Camera</button>

    <img id="capturedPreview" src="" class="hidden" alt="Captured Photo" style="margin-top:10px; max-width:100%; border-radius:8px;"/>
    
    <div style="margin-top:15px;">
      <button onclick="submitReport()" style="background:#fcd34d;color:#0a1636;">Submit</button>
      <button onclick="hideReportPopup()" style="background:#e63946;color:white;">Cancel</button>
    </div>
  </div>
</div>

<!-- Pinpoint Confirmation Popup -->
<div class="alert-overlay hidden" id="pinConfirmPopup">
  <div class="alert-box">
    <h2>Location Selected</h2>
    <p>Your chosen location has been pinned. Continue to report?</p>
    <div style="margin-top:15px;">
      <button onclick="hidePinConfirmPopup()" style="background:#e63946;color:white;margin-right:10px;">Cancel</button>
      <button onclick="continueFromPin()" style="background:#fcd34d;color:#0a1636;">Continue</button>
    </div>
  </div>
</div>

<!-- Final Confirmation Popup -->
<div class="alert-overlay hidden" id="alertOverlay">
  <div class="alert-box">
    <h2>Report Submitted</h2>
    <p>Thank you for your report. We will review it shortly.</p>
    <button onclick="hideAlert()" style="background:#fcd34d;color:#0a1636;">OK</button>
  </div>
</div>

<!-- Fullscreen Camera Overlay -->
<div id="cameraOverlay">
  <video id="cameraFeed" autoplay playsinline></video>
  <div>
    <button id="captureBtn">Capture</button>
    <button id="closeCameraBtn">Cancel</button>
  </div>
</div>

<script>
  function goBack() {
  window.location.href = "index.html";
}
/* ===========================
   MAP SETUP
=========================== */
const map = L.map('map').setView([12.35,122.0],11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19,
  attribution:'&copy; OpenStreetMap'
}).addTo(map);

let userMarker, userLocation = null;
let manualMarker = null;
let capturedBase64 = null;

if(navigator.geolocation){
  navigator.geolocation.watchPosition(pos=>{
    const {latitude,longitude} = pos.coords;
    userLocation = {lat:latitude,lng:longitude};
    if(!userMarker){
      userMarker = L.marker([latitude,longitude],
        {icon:L.divIcon({html:'<div class="pulse"></div>'})}).addTo(map);
      map.setView([latitude,longitude],14);
    } else {
      userMarker.setLatLng([latitude,longitude]);
    }
  }, ()=>alert("Please enable GPS."));
}

/* ===========================
   PINPOINT LOCATION
=========================== */
function startPinpoint(){
  alert("Click anywhere on the map to select the location you want to report.");
  map.once('click', function(e){
    if(manualMarker) map.removeLayer(manualMarker);
    manualMarker = L.marker(e.latlng).addTo(map).bindPopup("Pinned Location").openPopup();
    userLocation = e.latlng;
    showPinConfirmPopup();
  });
}

/* ===========================
   POPUP CONTROL
=========================== */
function showPenaltyPopup(){ hideAllPopups(); document.getElementById('penaltyPopup').classList.remove('hidden'); }
function hidePenaltyPopup(){ document.getElementById('penaltyPopup').classList.add('hidden'); }
function continueToReport(){ hideAllPopups(); document.getElementById('reportPopup').classList.remove('hidden'); }
function showPinConfirmPopup(){ hideAllPopups(); document.getElementById('pinConfirmPopup').classList.remove('hidden'); }
function hidePinConfirmPopup(){ document.getElementById('pinConfirmPopup').classList.add('hidden'); }
function continueFromPin(){ hidePinConfirmPopup(); setTimeout(() => showPenaltyPopup(), 200); }
function showAlert(){ hideAllPopups(); document.getElementById('alertOverlay').classList.remove('hidden'); }
function hideAlert(){ document.getElementById('alertOverlay').classList.add('hidden'); setTimeout(()=>window.location.href="index.html",1000);}
function hideAllPopups(){ document.querySelectorAll('.alert-overlay').forEach(p => p.classList.add('hidden')); }

/* ===========================
   FULLSCREEN CAMERA
=========================== */
const cameraOverlay = document.getElementById("cameraOverlay");
const cameraVideo = document.getElementById("cameraFeed");
const captureBtn = document.getElementById("captureBtn");
const closeCameraBtn = document.getElementById("closeCameraBtn");

let cameraStream = null;

// Open full-screen camera
async function openCamera(){
  hideAllPopups(); // hide report popup
  cameraOverlay.style.display = 'flex';
  try {
    cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
    cameraVideo.srcObject = cameraStream;
  } catch(err){
    alert("Unable to access camera.");
    console.error(err);
    cameraOverlay.style.display = 'none';
  }
}

// Capture photo and return to report popup
captureBtn.addEventListener("click", ()=>{
  const canvas = document.createElement("canvas");
  canvas.width = cameraVideo.videoWidth;
  canvas.height = cameraVideo.videoHeight;
  canvas.getContext("2d").drawImage(cameraVideo,0,0,canvas.width,canvas.height);
  capturedBase64 = canvas.toDataURL("image/jpeg");

  stopCamera();
  cameraOverlay.style.display = 'none';
  
  const preview = document.getElementById("capturedPreview");
  preview.src = capturedBase64;
  preview.classList.remove("hidden");

  document.getElementById('reportPopup').classList.remove('hidden');
});

// Cancel camera
closeCameraBtn.addEventListener("click", ()=>{
  stopCamera();
  cameraOverlay.style.display = 'none';
  document.getElementById('reportPopup').classList.remove('hidden');
});

// Stop camera stream
function stopCamera(){
  if(cameraStream){
    cameraStream.getTracks().forEach(track=>track.stop());
    cameraStream = null;
  }
}

/* ===========================
   REPORT CANCEL WITH RESET
=========================== */
function hideReportPopup(){
  document.getElementById('reportPopup').classList.add('hidden');
  stopCamera();

  // Clear captured camera photo
  capturedBase64 = null;
  const preview = document.getElementById("capturedPreview");
  preview.src = "";
  preview.classList.add("hidden");

  // Clear file input
  const photoInput = document.getElementById('incidentPhoto');
  photoInput.value = "";
}

/* ===========================
   SUBMIT REPORT
=========================== */
async function submitReport(){
  if(!userLocation){
    alert("Please select or wait for a location.");
    return;
  }

  const photoInput = document.getElementById('incidentPhoto');
  let photoBase64 = capturedBase64;

  if(!photoBase64 && photoInput.files.length > 0){
    const file = photoInput.files[0];
    photoBase64 = await toBase64(file);
  }

  const type = localStorage.getItem("accidentType") || "unknown";
  const reporter = localStorage.getItem("profileName") || "Anonymous";

  const report = {
    type,
    latitude: userLocation.lat,
    longitude: userLocation.lng,
    timestamp: new Date().toISOString(),
    reporter,
    photo: photoBase64
  };

  try{
    const res = await fetch("http://localhost:3000/api/reports", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(report)
    });
    if(!res.ok) throw new Error("Server error");
    hideReportPopup();
    showAlert();
  } catch(err){
    alert("Failed to send report to server.");
  }
}

function toBase64(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = ()=>resolve(reader.result);
    reader.onerror = reject;
  });
}
</script>
</body>
</html>
