<!DOCTYPE html> 
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AidTracker Map</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!--logo-->
<link rel="website icon" href="assets/aid-tracker-logo.png">

<style>
html,body { 
  height:100%; 
  margin:0; 
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
  overflow: hidden;
  font-size: 18px;
  
}
body {
  background: linear-gradient(135deg, #0a1636 70%, #d4af37 30%);
  color: white;
}
#map { 
  height:100vh; 
  width:100%; 
}

/* Pulsing user marker */
.pulse {
  width:16px; 
  height:16px; 
  background:#4d67fc; 
  border:2px solid #fff; 
  border-radius:50%;
  box-shadow:0 0 12px rgba(77, 115, 252, 0.8); 
  position:relative;
}
.pulse::after {
  content:""; 
  position:absolute; 
  top:50%; 
  left:50%; 
  width:24px; 
  height:24px; 
  border-radius:50%;
  background:rgba(252,211,77,0.3); 
  transform:translate(-50%,-50%);
  animation:pulse 1.5s infinite ease-out;
}
@keyframes pulse {
  0%{transform:translate(-50%,-50%) scale(0.8);opacity:0.8;}
  70%{transform:translate(-50%,-50%) scale(2);opacity:0;}
  100%{transform:translate(-50%,-50%) scale(0.8);opacity:0;}
}

/* Custom marker for pinpointed location */
.pinpoint-marker {
  background-color: #4ADE80;
  width: 20px;
  height: 20px;
  border: 3px solid #0a1636;
  border-radius: 50%;
  box-shadow: 0 0 15px rgba(74, 222, 128, 0.8);
  position: relative;
}
.pinpoint-marker::after {
  content: "";
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  width: 2px;
  height: 15px;
  background-color: #0a1636;
}

/* FIXED: Button container for better mobile layout - HIDDEN WHEN CAMERA IS ACTIVE */
.button-container {
  position: fixed;
  bottom: 20px;
  left: 0;
  right: 0;
  display: flex;
  justify-content: center;
  gap: 10px;
  padding: 0 15px;
  z-index: 1000;
  flex-wrap: wrap;
  transition: opacity 0.3s ease, transform 0.3s ease;
}

.button-container.hidden {
  display: none !important;
}

.map-button {
  padding: 14px 20px;
  background: #0a1636;
  color: #4ADE80;
  border: none;
  border-radius: 30px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.4);
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
  flex: 1;
  min-width: 140px;
  max-width: 200px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}
.map-button:hover { 
  background: #16224d; 
  color: #ffe066; 
  transform: translateY(-2px);
}

/* Header */
.header { 
  position: absolute; 
  top: 15px; 
  left: 50px; 
  z-index: 1000; 
}
.header button { 
  background: rgba(10, 22, 54, 0.85); 
  color: #4ADE80; 
  border: none; 
  border-radius: 50%; 
  width: 40px; 
  height: 40px; 
  font-size: 18px; 
  cursor: pointer; 
  box-shadow: 0 2px 8px rgba(0,0,0,0.3); 
  transition: all 0.3s ease;
}
.header button:hover {
  background: rgba(10, 22, 54, 1);
  transform: scale(1.05);
}

/* Page Title */
.page-title {
  position: absolute;
  top: 20px;
  left: 20px;
  right: 0;
  text-align: center;
  z-index: 999;
  margin: 0;
  font-size: 1.4rem;
  text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
  color: #4ADE80;
  pointer-events: none;
}

/* Popups - FIXED: Proper centering */
.alert-overlay {
  position: fixed; 
  top: 0; 
  left: 0; 
  width: 100%; 
  height: 100%;
  background-color: rgba(10,22,54,0.95);
  display: flex; 
  justify-content: center; 
  align-items: center;
  z-index: 2000;
  padding: 20px;
  box-sizing: border-box;
}
.alert-box {
  background: rgba(20, 35, 80, 0.95); 
  color: #fff;
  padding: 30px;
  border-radius: 16px;
  text-align: center;
  width: 100%;
  max-width: 420px;
  border: 1px solid rgba(252,211,77,0.3);
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  animation: slideIn 0.3s ease-out;
}
@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
.alert-box h2 {
  margin-top: 0;
  margin-bottom: 20px;
  color: #4ADE80;
  font-size: 1.5rem;
}
.alert-box p {
  margin-bottom: 25px;
  line-height: 1.5;
}

/* Improved Form Alignment */
.report-form {
  width: 100%;
  text-align: left;
}

.form-group {
  margin-bottom: 20px;
  width: 100%;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
  color: #f0f0f0;
  text-align: left;
}

/* File Upload Styling - FIXED: Updated for optional photo */
.file-upload-wrapper {
  width: 100%;
  margin-bottom: 20px;
  overflow: hidden;
}

.file-input-container {
  border: 2px dashed rgba(74, 222, 128, 0.4);
  border-radius: 10px;
  padding: 20px;
  text-align: center;
  background: rgba(255, 255, 255, 0.05);
  cursor: pointer;
  transition: all 0.3s ease;
  overflow: hidden;
}

.file-input-container:hover {
  border-color: #4ADE80;
  background: rgba(255, 255, 255, 0.08);
}

.file-input-label {
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
  width: 100%;
  height: 100%;
}

.file-input-icon {
  font-size: 2rem;
  color: #4ADE80;
  margin-bottom: 8px;
}

.file-input-text {
  font-size: 0.9rem;
  color: #e0e0e0;
  margin-bottom: 5px;
}

.file-input-hint {
  font-size: 0.8rem;
  color: #aaa;
}

#incidentPhoto {
  display: none;
}

#fileName {
  margin-top: 10px;
  font-size: 0.85rem;
  color: #4ADE80;
  font-style: italic;
  word-break: break-word;
  text-align: center;
}

/* Button Styling */
.button-group {
  display: flex;
  gap: 10px;
  margin-top: 20px;
  flex-wrap: wrap;
  justify-content: center;
}

.btn {
  padding: 12px 20px;
  border-radius: 8px;
  border: none;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 0.95rem;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  min-width: 120px;
  flex: 1;
}

.btn-primary {
  background: linear-gradient(to right, #4ADE80, #4ADE80);
  color: #0a1636;
}

.btn-primary:hover {
  background: linear-gradient(to right, #4ADE80, #f59e0b);
  transform: translateY(-2px);
}

.btn-secondary {
  background: rgba(255, 255, 255, 0.1);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.3);
}

.btn-secondary:hover {
  background: rgba(255, 255, 255, 0.2);
}

.btn-danger {
  background: #e63946;
  color: white;
}

.btn-danger:hover {
  background: #d62839;
}

/* Form Action Buttons */
.form-actions {
  display: flex;
  gap: 10px;
  margin-top: 25px;
  justify-content: center;
}

/* Image Preview - FIXED: Proper constraints */
#capturedPreview {
  max-width: 100% !important;
  max-height: 250px !important;
  width: auto !important;
  height: auto !important;
  border-radius: 8px;
  margin: 15px auto !important;
  border: 2px solid rgba(74, 222, 128, 0.5);
  display: none;
  object-fit: contain !important;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

#capturedPreview.show {
  display: block !important;
}

.hidden { 
  display: none !important; 
}

/* =================== FIXED: CAMERA OVERLAY - RESPONSIVE =================== */
#cameraOverlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(10, 22, 54, 0.98);
  z-index: 3001; /* Higher z-index than button container */
  overflow: hidden;
}

.camera-container {
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  height: 100%;
  padding: 20px;
  box-sizing: border-box;
}

.camera-header {
  text-align: center;
  color: #4ADE80;
  font-size: 1.2rem;
  font-weight: 600;
  text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
  margin-bottom: 10px;
}

.camera-viewport {
  width: 100%;
  max-width: 400px;
  height: auto;
  aspect-ratio: 4/3;
  background: #000;
  border-radius: 12px;
  overflow: hidden;
  position: relative;
  box-shadow: 0 8px 32px rgba(0,0,0,0.4);
  border: 3px solid #4ADE80;
  margin: 10px auto;
  flex-shrink: 0;
}

#cameraFeed {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.camera-controls {
  display: flex;
  flex-direction: column;
  gap: 15px;
  width: 100%;
  max-width: 400px;
  flex-shrink: 0;
}

.camera-main-btn {
  padding: 16px 20px;
  border-radius: 50px;
  border: none;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  font-size: 1rem;
  transition: all 0.3s ease;
}

.capture-btn {
  background: linear-gradient(to right, #4ADE80, #4ADE80);
  color: #0a1636;
  box-shadow: 0 4px 15px rgba(74, 222, 128, 0.3);
}

.capture-btn:hover {
  background: linear-gradient(to right, #4ADE80, #f59e0b);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(74, 222, 128, 0.4);
}

.cancel-btn {
  background: rgba(230, 57, 70, 0.9);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.cancel-btn:hover {
  background: rgba(214, 40, 57, 1);
  transform: translateY(-2px);
}

.camera-footer {
  text-align: center;
  color: rgba(255, 255, 255, 0.7);
  font-size: 0.85rem;
  padding: 10px 20px;
  margin-top: 10px;
  flex-shrink: 0;
}

/* Responsive */
@media (max-width: 768px) {
  .button-container {
    flex-direction: column;
    align-items: center;
    gap: 10px;
  }
  
  .map-button {
    max-width: 100%;
    width: 90%;
  }
  
  .alert-box {
    padding: 20px;
    max-width: 90%;
  }
  
  .btn {
    min-width: 100px;
    padding: 10px 15px;
  }
  
  .form-actions {
    flex-direction: column;
  }
  
  .button-group {
    flex-direction: column;
  }
  
  .page-title {
    font-size: 1.2rem;
    top: 15px;
  }
  
  /* Adjust image preview for mobile */
  #capturedPreview {
    max-height: 200px !important;
  }
  
  /* Camera adjustments for mobile */
  .camera-viewport {
    max-width: 90vw;
    margin: 15px auto;
  }
  
  .camera-controls {
    max-width: 90vw;
  }
  
  .camera-header {
    font-size: 1.1rem;
    top: 15px;
  }
  
  .camera-footer {
    bottom: 25px; /* More spacing for mobile */
  }
}

@media (max-width: 480px) {
  .button-container {
    bottom: 10px;
    padding: 0 10px;
  }

  .map-button {
    padding: 12px 15px;
    font-size: 0.9rem;
  }

  .alert-overlay {
    padding: 10px; /* Reduced padding for more space */
  }

  .alert-box {
    padding: 15px;
    max-width: 95%;
    max-height: 85vh; /* Limit height to prevent overflow */
    overflow-y: auto; /* Allow scrolling if content is too tall */
  }

  .alert-box h2 {
    font-size: 1.3rem;
  }

  /* Adjust image preview for small screens */
  #capturedPreview {
    max-height: 180px !important;
  }

  /* Camera adjustments for small screens */
  .camera-viewport {
    max-width: 95vw;
    aspect-ratio: 3/4;
    margin: 10px auto;
  }

  .camera-controls {
    max-width: 95vw;
    margin-top: 20px;
  }

  .camera-main-btn {
    padding: 14px 18px;
    font-size: 0.95rem;
  }

  .camera-header {
    font-size: 1rem;
    top: 10px;
  }

  .camera-footer {
    bottom: 20px; /* Even more spacing for small screens */
    font-size: 0.8rem;
  }

  /* Hide page title and header when camera is active on very small screens */
  body.camera-active .page-title,
  body.camera-active .header {
    display: none !important;
  }
}

/* Orientation-specific adjustments */
@media (max-height: 600px) {
  .camera-viewport {
    max-height: 60vh;
    margin: 10px auto;
  }
  
  .camera-controls {
    margin-top: 15px;
  }
  
  .camera-header {
    position: relative;
    top: 0;
    margin-bottom: 10px;
  }
  
  .camera-footer {
    bottom: 20px;
    font-size: 0.8rem;
  }
}

/* When camera is active, hide map controls */
body.camera-active .button-container,
body.camera-active .header,
body.camera-active .page-title,
body.camera-active #guestModeIndicator {
  display: none !important;
}

/* For landscape mode on mobile */
@media (max-width: 768px) and (orientation: landscape) {
  .camera-viewport {
    max-height: 70vh;
    max-width: 80vw;
    aspect-ratio: 16/9;
  }
  
  .camera-controls {
    flex-direction: row;
    justify-content: center;
    max-width: 80vw;
  }
  
  .camera-main-btn {
    min-width: 140px;
  }
  
  .camera-footer {
    bottom: 15px;
  }
}
</style>
</head>

<body>
  <div class="header">
    <button onclick="goBack()">
      <i class="fas fa-arrow-left"></i>
    </button>
  </div>
  
  <h1 class="page-title">AidTracker Map</h1>

  <!-- Guest Mode Indicator -->
  <div id="guestModeIndicator" class="hidden" style="position: absolute; top: 70px; left: 50%; transform: translateX(-50%); z-index: 999; background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(147, 197, 253, 0.2)); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 8px 16px; backdrop-filter: blur(10px);">
    <div class="flex items-center justify-center gap-2 text-blue-300">
      <i class="fas fa-user-clock text-lg"></i>
      <span class="font-medium">You are currently in Guest Mode</span>
      <span class="text-sm text-blue-200/80">(Reports will be anonymous)</span>
    </div>
  </div>

  <div id="map"></div>

  <!-- FIXED: Button Container - Will be hidden when camera is active -->
  <div class="button-container" id="mapButtons">
    <button id="reportBtn" class="map-button" onclick="openReportForm()">
      <i class="fas fa-exclamation-triangle"></i> Report Emergency
    </button>
    
    <button id="pinpointBtn" class="map-button" onclick="startPinpoint()">
      <i class="fas fa-map-marker-alt"></i> Pinpoint Location
    </button>
  </div>

  <!-- Report Form Popup (No penalty warning) -->
  <div class="alert-overlay hidden" id="reportPopup">
    <div class="alert-box">
      <h2>Submit Emergency Report</h2>
      
      <form class="report-form" id="emergencyForm">
        <!-- Show accident type -->
        <div class="form-group">
          <label>Emergency Type</label>
          <div style="
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid rgba(74, 222, 128, 0.3);
            border-radius: 8px;
            padding: 12px 15px;
            font-weight: 600;
            color: #4ADE80;
            text-align: center;
            margin-bottom: 20px;
          " id="emergencyTypeDisplay">
            Loading type...
          </div>
        </div>
        
        <!-- Photo Upload - UPDATED: Now optional with clear label -->
        <div class="form-group">
          <label>
            <span>Incident Photo</span>
            <span style="color: #94a3b8; font-size: 0.85rem; font-weight: normal; margin-left: 5px;">
              (Optional - Add visual evidence if available)
            </span>
          </label>
          <div class="file-upload-wrapper">
            <div class="file-input-container">
              <label class="file-input-label" for="incidentPhoto">
                <div class="file-input-icon">
                  <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="file-input-text">Upload or Take Photo</div>
                <div class="file-input-hint">Optional - JPEG, PNG up to 10MB</div>
                <input type="file" id="incidentPhoto" accept="image/*">
              </label>
            </div>
            <div id="fileName"></div>
          </div>
          
          <!-- Image Preview -->
          <img id="capturedPreview" class="hidden">
          
          <!-- Camera Button -->
          <div style="margin-top: 15px; text-align: center;">
            <button type="button" onclick="openCamera()" class="btn btn-secondary">
              <i class="fas fa-camera"></i> Open Camera
            </button>
          </div>
        </div>
        
        <!-- Form Actions -->
        <div class="form-actions">
          <button type="button" onclick="submitReport()" class="btn btn-primary">
            <i class="fas fa-paper-plane"></i> Submit Report
          </button>
          <button type="button" onclick="hideReportPopup()" class="btn btn-danger">
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="alert-overlay hidden" id="pinConfirmPopup">
    <div class="alert-box">
      <h2>Location Selected</h2>
      <p>Continue to report?</p>
      <div class="button-group">
        <button onclick="hidePinConfirmPopup()" class="btn btn-danger">Cancel</button>
        <button onclick="continueFromPin()" class="btn btn-primary">Continue</button>
      </div>
    </div>
  </div>

  <div class="alert-overlay hidden" id="alertOverlay">
    <div class="alert-box">
      <h2>Report Submitted</h2>
      <p id="successMessage">Emergency services have been notified.</p>
      <button onclick="goBackToIndex()" class="btn btn-primary">OK</button>
    </div>
  </div>

  <!-- =================== FIXED: CAMERA OVERLAY - RESPONSIVE =================== -->
  <div id="cameraOverlay">
    <div class="camera-container">
      <div class="camera-header">
        <i class="fas fa-camera"></i> Camera
      </div>
      
      <div class="camera-viewport">
        <video id="cameraFeed" autoplay playsinline></video>
      </div>
      
      <div class="camera-controls">
        <button id="captureBtn" class="camera-main-btn capture-btn">
          <i class="fas fa-camera"></i> Capture Photo
        </button>
        <button id="closeCameraBtn" class="camera-main-btn cancel-btn">
          <i class="fas fa-times"></i> Cancel
        </button>
      </div>
      
      <div class="camera-footer">
        Tap "Capture Photo" to take a picture
      </div>
    </div>
  </div>

  <!-- Supabase Module -->
  <script type="module">
    // Import functions from notif-report.js
    import { 
        saveReportToSupabase, 
        testSupabaseConnection,
        getAllReports 
    } from "./notif-report.js";
    
    // Make functions available globally
    window.saveReportToSupabase = saveReportToSupabase;
    window.testSupabaseConnection = testSupabaseConnection;
    window.getAllReports = getAllReports;
    
    // Initialize form and camera button listeners
    document.addEventListener('DOMContentLoaded', function() {
        const captureBtn = document.getElementById('captureBtn');
        const closeCameraBtn = document.getElementById('closeCameraBtn');
        const fileInput = document.getElementById('incidentPhoto');
        const fileName = document.getElementById('fileName');
        
        if (captureBtn) {
            captureBtn.onclick = capturePhoto;
        }
        
        if (closeCameraBtn) {
            closeCameraBtn.onclick = closeCamera;
        }
        
        if (fileInput) {
            fileInput.addEventListener('change', function(e) {
                handleFileSelect(e);
            });
        }
        
        // Prevent form submission
        const form = document.getElementById('emergencyForm');
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                submitReport();
            });
        }
        
        // Display the accident type when report form is shown
        updateEmergencyTypeDisplay();
        
        // Test Supabase connection on load
        testConnection();
    });
    
    // Test Supabase connection
    async function testConnection() {
        try {
            if (window.testSupabaseConnection) {
                const result = await window.testSupabaseConnection();
                console.log("Supabase connection test:", result);
                
                if (!result.connected) {
                    console.warn("Supabase connection warning:", result.error);
                    
                    // Show warning if not connected
                    if (result.error && !result.error.includes('42P01')) {
                        console.warn("Supabase may not be properly configured.");
                    }
                } else {
                    console.log("âœ“ Supabase connection successful");
                }
            }
        } catch (error) {
            console.error("Connection test error:", error);
        }
    }
    
    // FIXED: Handle file selection with preview
    function handleFileSelect(e) {
        const fileInput = document.getElementById('incidentPhoto');
        const fileName = document.getElementById('fileName');
        const capturedPreview = document.getElementById('capturedPreview');
        
        if (e.target.files && e.target.files.length > 0) {
            const file = e.target.files[0];
            
            // Check if file is an image
            if (!file.type.match('image.*')) {
                alert('Please select an image file (JPEG, PNG, etc.)');
                fileInput.value = '';
                return;
            }
            
            // Check file size (limit to 10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('File size should be less than 10MB');
                fileInput.value = '';
                return;
            }
            
            fileName.textContent = `Selected: ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`;
            
            // Preview the image
            const reader = new FileReader();
            reader.onload = function(e) {
                if (capturedPreview) {
                    capturedPreview.src = e.target.result;
                    capturedPreview.classList.remove("hidden");
                    capturedPreview.classList.add("show");
                    
                    // Resize very large images for better display
                    const img = new Image();
                    img.onload = function() {
                        if (img.width > 800 || img.height > 600) {
                            // Create canvas to resize
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            // Calculate new dimensions
                            let width = img.width;
                            let height = img.height;
                            const MAX_WIDTH = 800;
                            const MAX_HEIGHT = 600;
                            
                            if (width > height) {
                                if (width > MAX_WIDTH) {
                                    height *= MAX_WIDTH / width;
                                    width = MAX_WIDTH;
                                }
                            } else {
                                if (height > MAX_HEIGHT) {
                                    width *= MAX_HEIGHT / height;
                                    height = MAX_HEIGHT;
                                }
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // Update preview with resized image
                            capturedPreview.src = canvas.toDataURL('image/jpeg', 0.8);
                        }
                    };
                    img.src = e.target.result;
                }
                
                // Clear any camera-captured image
                capturedBase64 = null;
            };
            reader.readAsDataURL(file);
        } else {
            fileName.textContent = '';
            if (capturedPreview) {
                capturedPreview.src = '';
                capturedPreview.classList.remove("show");
                capturedPreview.classList.add("hidden");
            }
        }
    }
    
    // Quick test function - call this in browser console to debug
    window.testSupabaseManually = async function() {
        console.log("Testing Supabase connection manually...");
        console.log("Window.saveReportToSupabase exists:", typeof window.saveReportToSupabase);
        
        if (typeof window.testSupabaseConnection === 'function') {
            const result = await window.testSupabaseConnection();
            console.log("Connection test result:", result);
            return result;
        } else {
            console.error("testSupabaseConnection function not available");
            return { connected: false, error: "Function not loaded" };
        }
    };
  </script>

  <script>
    // Global variables
    let map = null;
    let currentUserLocation = null;  // User's current GPS location
    let reportLocation = null;        // Location to use for reporting
    let userMarker = null;
    let pinpointMarker = null;        // Marker for pinpointed location
    let capturedBase64 = null;
    let cameraStream = null;
    let mapButtons = null;

    // Initialize when DOM loads
    document.addEventListener('DOMContentLoaded', function() {
      initializeMap();
      mapButtons = document.getElementById('mapButtons');

      // Show/hide guest mode indicator
      const isGuestMode = localStorage.getItem('isGuestMode') === 'true';
      const guestIndicator = document.getElementById('guestModeIndicator');

      if (guestIndicator) {
        if (isGuestMode) {
          guestIndicator.classList.remove('hidden');
        } else {
          guestIndicator.classList.add('hidden');
        }
      }
    });

    /* ============================ MAP INITIALIZATION ============================= */
    function initializeMap() {
      map = L.map('map').setView([12.35, 122.0], 11);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      
      // Start GPS tracking for user's current location
      startGeoTracking();
    }

    function goBack() { 
      window.location = "index.html"; 
    }
    
    // NEW: Function to go back to index after report submission
    function goBackToIndex() {
      window.location.href = "index.html";
    }

    /* ============================ GPS TRACKING ============================= */
    function startGeoTracking() {
      if (!navigator.geolocation) {
        console.warn("Geolocation is not supported by this browser");
        alert("Geolocation is not supported by your browser. You can still use the map by pinpointing locations manually.");
        return;
      }

      // Check if we already have a location from localStorage
      const savedLocation = localStorage.getItem('lastKnownLocation');
      if (savedLocation) {
        try {
          const location = JSON.parse(savedLocation);
          if (location && location.lat && location.lng) {
            currentUserLocation = location;
            if (!reportLocation) {
              reportLocation = location;
            }
            if (!userMarker) {
              userMarker = L.marker([location.lat, location.lng], {
                icon: L.divIcon({ html: '<div class="pulse"></div>' })
              }).addTo(map);
              map.setView([location.lat, location.lng], 14);
            }
          }
        } catch (e) {
          console.warn("Error parsing saved location:", e);
        }
      }

      // Try to get current location with better error handling
      const options = {
        enableHighAccuracy: false, // Start with low accuracy
        maximumAge: 300000, // Accept locations up to 5 minutes old
        timeout: 15000 // 15 second timeout
      };

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude, accuracy } = pos.coords;
          console.log(`Location obtained with accuracy: ${accuracy} meters`);

          currentUserLocation = { lat: latitude, lng: longitude };

          // Save to localStorage for future use
          localStorage.setItem('lastKnownLocation', JSON.stringify(currentUserLocation));

          // Set initial report location to current location
          if (!reportLocation) {
            reportLocation = { lat: latitude, lng: longitude };
          }

          if (!userMarker) {
            userMarker = L.marker([latitude, longitude], {
              icon: L.divIcon({ html: '<div class="pulse"></div>' })
            }).addTo(map);
            map.setView([latitude, longitude], 14);
          } else {
            userMarker.setLatLng([latitude, longitude]);
          }

          // Now start watching for position changes with low accuracy
          startPositionWatch();
        },
        (error) => {
          console.warn("Initial geolocation failed:", error);

          // Provide user-friendly error messages
          let errorMessage = "Unable to get your location. ";
          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMessage += "Please enable location permissions in your browser settings and refresh the page.";
              break;
            case error.POSITION_UNAVAILABLE:
              errorMessage += "Location information is unavailable. You can still use the map by pinpointing locations manually.";
              break;
            case error.TIMEOUT:
              errorMessage += "Location request timed out. You can still use the map by pinpointing locations manually.";
              break;
            default:
              errorMessage += "You can still use the map by pinpointing locations manually.";
              break;
          }

          alert(errorMessage);

          // Still allow map usage without GPS
          if (!userMarker) {
            // Center on default location if no saved location
            map.setView([12.35, 122.0], 11);
          }
        },
        options
      );
    }

    function startPositionWatch() {
      if (!navigator.geolocation) return;

      const watchOptions = {
        enableHighAccuracy: false, // Keep low accuracy for continuous tracking
        maximumAge: 60000, // Accept 1 minute old locations
        timeout: 30000 // 30 second timeout
      };

      navigator.geolocation.watchPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;
          currentUserLocation = { lat: latitude, lng: longitude };

          // Update localStorage
          localStorage.setItem('lastKnownLocation', JSON.stringify(currentUserLocation));

          // Update marker position if it exists
          if (userMarker) {
            userMarker.setLatLng([latitude, longitude]);
          }
        },
        (error) => {
          console.warn("Position watch error:", error);
          // Don't show alert for watch errors, just log them
        },
        watchOptions
      );
    }

    /* ============================ PINPOINT ============================= */
    function startPinpoint() {
      if (!map) {
        alert("Map not loaded yet. Please wait.");
        return;
      }
      
      alert("Tap on map to set report location.");
      map.once("click", (e) => {
        // Remove previous pinpoint marker if exists
        if (pinpointMarker) {
          map.removeLayer(pinpointMarker);
        }
        
        // Create new pinpoint marker with custom style
        pinpointMarker = L.marker(e.latlng, {
          icon: L.divIcon({ 
            html: '<div class="pinpoint-marker"></div>',
            className: 'pinpoint-icon',
            iconSize: [20, 35],
            iconAnchor: [10, 35]
          })
        }).addTo(map);
        
        // Bind popup to pinpoint marker
        pinpointMarker.bindPopup("Report will be submitted here").openPopup();
        
        // Set report location to the pinpointed location
        reportLocation = e.latlng;
        
        showPinConfirmPopup();
      });
    }

    /* ============================ POPUP MANAGEMENT ============================= */
    const reportPopup = document.getElementById("reportPopup");
    const pinConfirmPopup = document.getElementById("pinConfirmPopup");
    const alertOverlay = document.getElementById("alertOverlay");

    // REMOVED: showPenaltyPopup function and penaltyPopup references
    
    // UPDATED: Directly open report form
    function openReportForm() { 
      hideAll(); 
      reportPopup.classList.remove("hidden"); 
    }

    function showPinConfirmPopup() { 
      hideAll(); 
      pinConfirmPopup.classList.remove("hidden"); 
    }

    function hidePinConfirmPopup() { 
      pinConfirmPopup.classList.add("hidden"); 
    }

    function continueFromPin() { 
      hidePinConfirmPopup(); 
      openReportForm(); 
    }

    function showAlert() { 
      hideAll(); 
      alertOverlay.classList.remove("hidden"); 
      
      // Update the success message with status
      const successMsg = document.getElementById("successMessage");
      if (successMsg) {
        successMsg.textContent = "Emergency report submitted successfully. Status: Pending - Awaiting response from emergency services.";
      }
    }

    function hideAlert() { 
      alertOverlay.classList.add("hidden"); 
    }

    function hideAll() {
      document.querySelectorAll(".alert-overlay").forEach(x => x.classList.add("hidden"));
    }

    /* =================== FIXED: CAMERA FUNCTIONS - RESPONSIVE =================== */
    const cameraOverlay = document.getElementById("cameraOverlay");
    const cameraVideo = document.getElementById("cameraFeed");
    const capturedPreview = document.getElementById("capturedPreview");

    async function openCamera() {
      // Hide all overlays and map buttons
      hideAll();
      if (mapButtons) {
        mapButtons.classList.add('hidden');
      }
      
      // Add camera-active class to body
      document.body.classList.add('camera-active');
      
      // Show camera overlay
      cameraOverlay.style.display = "block";

      try {
        // Try to use rear camera (environment) first, fall back to any camera
        const constraints = {
          video: {
            facingMode: { ideal: 'environment' },
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        };

        cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
        cameraVideo.srcObject = cameraStream;
        
        // Wait for video to be ready
        return new Promise((resolve) => {
          cameraVideo.onloadedmetadata = () => {
            console.log("Camera ready, video dimensions:", cameraVideo.videoWidth, "x", cameraVideo.videoHeight);
            
            // Force a small delay for proper rendering
            setTimeout(() => {
              // Fix for mobile Safari/WebKit browsers
              cameraVideo.play()
                .then(() => {
                  console.log("Camera video playing successfully");
                  resolve(true);
                })
                .catch(err => {
                  console.warn("Video play failed, but camera should work:", err);
                  resolve(true);
                });
            }, 300);
          };
        });
      } catch (error) {
        console.error("Camera error:", error);
        
        // Try again with less restrictive constraints
        try {
          console.log("Trying with simpler camera constraints...");
          cameraStream = await navigator.mediaDevices.getUserMedia({ 
            video: true 
          });
          cameraVideo.srcObject = cameraStream;
          
          cameraVideo.onloadedmetadata = () => {
            cameraVideo.play().catch(e => console.warn("Play warning:", e));
          };
        } catch (secondError) {
          console.error("Second camera attempt failed:", secondError);
          alert("Unable to access camera. Please check camera permissions in your browser settings.");
          closeCamera(); // Use closeCamera to properly restore UI
        }
      }
    }

    function capturePhoto() {
      if (!cameraVideo || !cameraVideo.videoWidth) {
        alert("Camera not ready. Please try again.");
        return;
      }

      const canvas = document.createElement("canvas");
      
      // Set maximum dimensions for the captured image
      const MAX_WIDTH = 1200;
      const MAX_HEIGHT = 900;
      
      let width = cameraVideo.videoWidth;
      let height = cameraVideo.videoHeight;
      
      // Calculate new dimensions maintaining aspect ratio
      if (width > height) {
        if (width > MAX_WIDTH) {
          height = Math.round(height * (MAX_WIDTH / width));
          width = MAX_WIDTH;
        }
      } else {
        if (height > MAX_HEIGHT) {
          width = Math.round(width * (MAX_HEIGHT / height));
          height = MAX_HEIGHT;
        }
      }
      
      canvas.width = width;
      canvas.height = height;
      
      // Draw and scale the image
      const ctx = canvas.getContext("2d");
      ctx.drawImage(cameraVideo, 0, 0, width, height);
      
      // Reduce image quality to save bandwidth (80% quality for good balance)
      capturedBase64 = canvas.toDataURL("image/jpeg", 0.8);

      // Close camera and restore UI
      stopCamera();
      closeCamera();
      
      if (capturedPreview) {
        capturedPreview.src = capturedBase64;
        capturedPreview.classList.remove("hidden");
        capturedPreview.classList.add("show");
      }

      // Update file input display
      const fileName = document.getElementById("fileName");
      if (fileName) {
        fileName.textContent = "Photo captured from camera";
      }

      // Clear any uploaded file
      const fileInput = document.getElementById("incidentPhoto");
      if (fileInput) {
        fileInput.value = '';
      }

      // Show report form again
      reportPopup.classList.remove("hidden");
    }

    function closeCamera() {
      // Stop camera
      stopCamera();
      
      // Hide camera overlay
      cameraOverlay.style.display = "none";
      
      // Remove camera-active class from body
      document.body.classList.remove('camera-active');
      
      // Restore map buttons
      if (mapButtons) {
        mapButtons.classList.remove('hidden');
      }
      
      // Show report form again
      reportPopup.classList.remove("hidden");
    }

    function stopCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => {
          track.stop();
        });
        cameraStream = null;
        cameraVideo.srcObject = null;
      }
    }

    /* ============================ UPDATE EMERGENCY TYPE DISPLAY ============================= */
    function updateEmergencyTypeDisplay() {
      const accidentType = localStorage.getItem("accidentType") || "emergency";
      let displayText = "Emergency";
      let typeValue = "emergency";

      // Map the accident type to display text and value
      switch(accidentType) {
        case "vehicular":
          displayText = "Vehicular Accident";
          typeValue = "vehicular";
          break;
        case "medical":
          displayText = "Medical Emergency";
          typeValue = "medical";
          break;
        case "fire":
          displayText = "Fire Accident";
          typeValue = "fire";
          break;
        case "assault":
          displayText = "Assault Crime";
          typeValue = "assault";
          break;
        default:
          displayText = "Emergency";
          typeValue = "emergency";
      }
      
      // Update the display
      const displayElement = document.getElementById("emergencyTypeDisplay");
      if (displayElement) {
        displayElement.textContent = displayText;
      }
      
      // Store the actual type value for submission
      window.currentAccidentType = typeValue;
      window.currentAccidentDisplay = displayText;
    }

    /* ============================ SUBMIT REPORT ============================= */
    async function submitReport() {
      // Check if we have a report location (either pinpointed or current)
      if (!reportLocation) {
        alert("Please select a location first. Use 'Pinpoint Location' or wait for GPS to get your current location.");
        return;
      }

      const fileInput = document.getElementById('incidentPhoto');
      let photoBase64 = capturedBase64;

      // If no camera photo, check for uploaded file
      if (!photoBase64 && fileInput.files.length > 0) {
        const file = fileInput.files[0];
        photoBase64 = await toBase64(file);
      }

      // Get the accident type from localStorage or use the current one
      const accidentType = localStorage.getItem("accidentType") || window.currentAccidentType || "emergency";
      const accidentDisplay = window.currentAccidentDisplay || "Emergency";
      
      // Get reporter name from localStorage - FIXED: Using reporterName from account page
      const reporterName = localStorage.getItem("reporterName") || "Anonymous";
      
      const report = {
        type: accidentType,
        type_display: accidentDisplay,
        reporter: reporterName,
        latitude: reportLocation.lat,
        longitude: reportLocation.lng,
        timestamp: new Date().toISOString(),
        status: "pending"
      };

      // Show location info for debugging
      console.log("Submitting report from location:", reportLocation);
      console.log("Current user location:", currentUserLocation);
      console.log("Using pinpoint location:", pinpointMarker ? "YES" : "NO");
      console.log("Report status:", report.status);
      console.log("Reporter name:", report.reporter);

      try {
        console.log("Submitting report...", report);
        
        // Check if function is available
        if (typeof window.saveReportToSupabase !== 'function') {
          throw new Error("Save function not loaded. Please check the console for import errors.");
        }
        
        console.log("Calling saveReportToSupabase...");
        const result = await window.saveReportToSupabase(report, photoBase64);
        
        console.log("Report submission result:", result);
        
        if (result && result.success) {
          hideReportPopup();
          showAlert();
          
          // Clear localStorage accident type after successful submission
          localStorage.removeItem("accidentType");
        } else {
          throw new Error("Report submission failed without error");
        }
        
      } catch(err) {
        console.error("Report submission error:", err);
        
        // User-friendly error messages
        let errorMessage = "Failed to submit report: ";
        
        if (err.message.includes("Database table 'reports' not found")) {
          errorMessage += "Database table not found. Please create the 'reports' table in Supabase.";
        } else if (err.message.includes("Bucket not found")) {
          errorMessage += "Storage bucket not found. Please create the 'aid-upload' bucket in Supabase Storage.";
        } else if (err.message.includes("Supabase client not initialized")) {
          errorMessage += "Connection failed. Please refresh the page and check your internet connection.";
        } else if (err.message.includes("Invalid status value")) {
          errorMessage += "Invalid report status. Please contact support.";
        } else if (err.message.includes("row-level security policy")) {
          errorMessage += "Permission denied. Check Supabase Row Level Security policies.";
        } else if (err.message.includes("Could not find")) {
          errorMessage += "Resource not found. Please check your Supabase setup.";
        } else {
          errorMessage += err.message;
        }
        
        alert(errorMessage);
      }
    }

    function hideReportPopup() {
      reportPopup.classList.add("hidden");
      capturedBase64 = null;
      
      if (capturedPreview) {
        capturedPreview.src = "";
        capturedPreview.classList.add("hidden");
        capturedPreview.classList.remove("show");
      }
      
      // Reset form
      const form = document.getElementById("emergencyForm");
      if (form) {
        form.reset();
      }
      
      const fileName = document.getElementById("fileName");
      if (fileName) {
        fileName.textContent = "";
      }
      
      // Clear file input
      const fileInput = document.getElementById("incidentPhoto");
      if (fileInput) {
        fileInput.value = '';
      }
    }

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
  </script>
</body>
</html>