<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>View Report Location</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100%; }
    .popup-img {
      width: 100%;
      max-width: 250px;
      border-radius: 8px;
      margin-top: 8px;
      cursor: pointer;
    }
    .popup-img:hover {
      opacity: 0.9;
    }
    #loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 18px;
      color: #333;
      background: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="loading">Loading report location...</div>
  <div id="map"></div>

  <!-- Load scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <script>
    // --- GET REPORT ID FROM URL ---
    function getReportIdFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      let reportID = urlParams.get("id");
      
      if (reportID) {
        reportID = reportID.trim();
      }
      
      return reportID;
    }

    const reportID = getReportIdFromURL();

    // --- SUPABASE CONFIG ---
    const supabaseUrl = 'https://gwvepxupoxyyydnisulb.supabase.co';
    const supabaseKey = 'sb_publishable_4baWNqraxymp0Gal3OKhxQ_Bl-IHHdt';
    
    // Create Supabase client
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // --- REAL GEOCODING FUNCTION WITH OPENCAGE (CORS ENABLED) ---
    async function getLocationName(lat, lng) {
      try {
        // OpenCage Data API - Supports CORS
        // Using YOUR API key
        const apiKey = '0a78fbd8bcd74be398f210b34682c77c';
        const url = `https://api.opencagedata.com/geocode/v1/json?q=${lat}+${lng}&key=${apiKey}&language=en&pretty=1&no_annotations=1`;
        
        console.log("Geocoding coordinates:", lat, lng);
        
        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'Accept': 'application/json'
          }
        });
        
        if (!response.ok) {
          console.error("Geocoding API error:", response.status);
          throw new Error(`Geocoding failed: ${response.status}`);
        }
        
        const data = await response.json();
        
        console.log("Geocoding API response:", data);
        
        if (data.results && data.results.length > 0) {
          const result = data.results[0];
          const components = result.components;
          
          // Build location name from most specific to general
          let locationParts = [];
          
          // Add specific location parts (most specific first)
          if (components.road) locationParts.push(components.road);
          if (components.village) locationParts.push(components.village);
          if (components.suburb) locationParts.push(components.suburb);
          if (components.neighbourhood) locationParts.push(components.neighbourhood);
          if (components.town) locationParts.push(components.town);
          if (components.city) locationParts.push(components.city);
          if (components.municipality) locationParts.push(components.municipality);
          if (components.county) locationParts.push(components.county);
          if (components.state) locationParts.push(components.state);
          if (components.country) locationParts.push(components.country);
          
          // If we have specific location info
          if (locationParts.length > 0) {
            // Remove duplicates while preserving order
            const uniqueParts = [...new Set(locationParts)];
            return uniqueParts.join(', ');
          }
          
          // Fallback to formatted address
          if (result.formatted) {
            return result.formatted;
          }
        }
        
        // If no results, return coordinates
        return `Coordinates: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        
      } catch (error) {
        console.error("Geocoding error:", error);
        // Fallback to coordinates
        return `Coordinates: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      }
    }

    // --- LOAD REPORT FROM SUPABASE ---
    async function loadReport() {
      try {
        if (!reportID) {
          alert("Missing report ID! Please go back to notifications.");
          window.location.href = "notif.html";
          return;
        }

        console.log("Fetching report ID:", reportID);

        // Fetch report from Supabase
        const { data: report, error } = await supabase
          .from('reports')
          .select('*')
          .eq('id', reportID)
          .single();

        if (error) {
          console.error("Supabase error:", error);
          alert("Report not found or database error: " + error.message);
          window.location.href = "notif.html";
          return;
        }

        if (!report) {
          alert("Report not found in database.");
          window.location.href = "notif.html";
          return;
        }

        console.log("Report loaded:", report);

        if (!report.latitude || !report.longitude) {
          alert("Report is missing coordinates!");
          return;
        }

        // Get location name
        const loadingDiv = document.getElementById('loading');
        loadingDiv.innerHTML = "Getting location name...";
        
        let displayLocation = report.location; // First priority: database location
        
        // If no location in database, get it from coordinates
        if (!displayLocation || displayLocation.trim() === '') {
          displayLocation = await getLocationName(report.latitude, report.longitude);
        }
        
        // Hide loading, show map
        loadingDiv.style.display = 'none';
        
        // Initialize map centered on report location
        const map = L.map("map").setView([report.latitude, report.longitude], 15);

        // Add OpenStreetMap tiles
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap contributors"
        }).addTo(map);

        // Format coordinates for display
        const formattedCoords = `${report.latitude?.toFixed(6)}, ${report.longitude?.toFixed(6)}`;
        
        // Create detailed popup content
        let popupContent = `
          <div style="text-align:center; padding: 10px; max-width: 300px;">
            <h3 style="font-weight: bold; font-size: 18px; color: #dc2626; margin-bottom: 8px;">
              ${(report.type?.toUpperCase() || 'EMERGENCY').replace(/[&<>"']/g, m => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
              }[m]))}
            </h3>
            <div style="text-align: left; font-size: 14px; color: #374151;">
              <p><strong>Reporter:</strong> ${(report.reporter || 'Anonymous').replace(/[&<>"']/g, m => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
              }[m]))}</p>
              <p><strong>Time Reported:</strong> ${new Date(report.created_at).toLocaleString()}</p>
              <p><strong>Coordinates:</strong> ${formattedCoords}</p>
              <p><strong>Location:</strong> ${displayLocation.replace(/[&<>"']/g, m => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
              }[m]))}</p>
        `;
        
        if (report.description) {
          popupContent += `<p><strong>Description:</strong> ${report.description.replace(/[&<>"']/g, m => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
          }[m]))}</p>`;
        }
        
        if (report.status) {
          popupContent += `<p><strong>Status:</strong> ${report.status.replace(/[&<>"']/g, m => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
          }[m]))}</p>`;
        }
        
        if (report.priority) {
          popupContent += `<p><strong>Priority:</strong> ${report.priority.replace(/[&<>"']/g, m => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
          }[m]))}</p>`;
        }
        
        popupContent += `</div>`;

        if (report.photo_url) {
          const escapedPhotoUrl = report.photo_url.replace(/[&<>"']/g, m => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
          }[m]));
          
          popupContent += `
            <div style="margin-top: 12px;">
              <img src="${escapedPhotoUrl}" 
                   class="popup-img" 
                   alt="Report photo"
                   onclick="window.open('${escapedPhotoUrl}', '_blank')"
                   title="Click to view full size">
              <p style="color: #6b7280; font-size: 11px; margin-top: 4px;">
                Click image to view full size
              </p>
            </div>
          `;
        }
        
        popupContent += `</div>`;

        // Add main report marker
        const marker = L.marker([report.latitude, report.longitude], {
          icon: L.icon({
            iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
          })
        }).addTo(map);
        
        marker.bindPopup(popupContent).openPopup();

        // Add circle around report for better visibility
        L.circle([report.latitude, report.longitude], {
          color: 'red',
          fillColor: '#f03',
          fillOpacity: 0.1,
          radius: 100
        }).addTo(map);

        // Add scale control
        L.control.scale({ imperial: false, position: 'bottomleft' }).addTo(map);

        // Update the page title
        let titleLocation = displayLocation.split(',')[0];
        document.title = `Report at ${titleLocation}`;

      } catch (error) {
        console.error("Error loading report:", error);
        document.getElementById('loading').innerHTML = 
          '<div style="color: red;">Error loading report. <br><br>' +
          '<button onclick="location.href=\'notif.html\'">Go Back</button></div>';
      }
    }

    // Load when page is ready
    document.addEventListener('DOMContentLoaded', loadReport);
  </script>
</body>
</html>