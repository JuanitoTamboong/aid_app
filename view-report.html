<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>View Report Location</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100%; }
    .popup-img {
      width: 100%;
      max-width: 250px;
      border-radius: 8px;
      margin-top: 8px;
      cursor: pointer;
    }
    .popup-img:hover {
      opacity: 0.9;
    }
    #loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 18px;
      color: #333;
      background: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="loading">Loading report location...</div>
  <div id="map"></div>

  <!-- Load scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <script>
    // --- GET REPORT ID FROM URL ---
    const urlParams = new URLSearchParams(window.location.search);
    const reportID = urlParams.get("id");

    // --- SUPABASE CONFIG ---
    const supabaseUrl = 'https://gwvepxupoxyyydnisulb.supabase.co';
    const supabaseKey = 'sb_publishable_4baWNqraxymp0Gal3OKhxQ_Bl-IHHdt';
    
    // Create Supabase client
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // --- REVERSE GEOCODING FUNCTION ---
    async function reverseGeocode(lat, lng) {
      try {
        // Using OpenStreetMap Nominatim API (free, no API key required)
        const response = await fetch(
          `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`
        );
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.error) {
          console.warn("Reverse geocoding error:", data.error);
          return null;
        }
        
        // Extract address components
        const address = data.address;
        let locationName = '';
        
        // Build a readable location name
        if (address.road) locationName += address.road;
        if (address.suburb) locationName += (locationName ? ', ' : '') + address.suburb;
        if (address.city || address.town || address.village) {
          locationName += (locationName ? ', ' : '') + (address.city || address.town || address.village);
        }
        if (address.state) locationName += (locationName ? ', ' : '') + address.state;
        if (address.country) locationName += (locationName ? ', ' : '') + address.country;
        
        // If we have a display name, use it as fallback
        if (!locationName && data.display_name) {
          locationName = data.display_name.split(',')[0]; // Get first part
        }
        
        return locationName || "Unknown Location";
      } catch (error) {
        console.error("Reverse geocoding failed:", error);
        return null;
      }
    }

    // --- LOAD REPORT FROM SUPABASE ---
    async function loadReport() {
      try {
        if (!reportID) {
          alert("Missing report ID! Please go back to notifications.");
          window.location.href = "notif.html";
          return;
        }

        console.log("Fetching report ID:", reportID);

        // Fetch report from Supabase
        const { data: report, error } = await supabase
          .from('reports')
          .select('*')
          .eq('id', reportID)
          .single();

        if (error) {
          console.error("Supabase error:", error);
          alert("Report not found or database error: " + error.message);
          window.location.href = "notif.html";
          return;
        }

        if (!report) {
          alert("Report not found in database.");
          window.location.href = "notif.html";
          return;
        }

        console.log("Report loaded:", report);

        if (!report.latitude || !report.longitude) {
          alert("Report is missing coordinates!");
          return;
        }

        // Get location name from coordinates
        const loadingDiv = document.getElementById('loading');
        loadingDiv.innerHTML = "Loading location details...";
        
        const locationName = await reverseGeocode(report.latitude, report.longitude);
        
        // Hide loading, show map
        loadingDiv.style.display = 'none';
        
        // Initialize map centered on report location
        const map = L.map("map").setView([report.latitude, report.longitude], 15);

        // Add OpenStreetMap tiles
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap contributors"
        }).addTo(map);

        // Create detailed popup content
        let popupContent = `
          <div style="text-align:center; padding: 10px; max-width: 300px;">
            <h3 style="font-weight: bold; font-size: 18px; color: #dc2626; margin-bottom: 8px;">
              ${report.type?.toUpperCase() || 'EMERGENCY'}
            </h3>
            <div style="text-align: left; font-size: 14px; color: #374151;">
              <p><strong>Reporter:</strong> ${report.reporter || 'Anonymous'}</p>
              <p><strong>Time Reported:</strong> ${new Date(report.created_at).toLocaleString()}</p>
              <p><strong>Coordinates:</strong> ${report.latitude?.toFixed(6)}, ${report.longitude?.toFixed(6)}</p>
              <p><strong>Location:</strong> ${locationName || report.location || 'Location not available'}</p>
              ${report.description ? `<p><strong>Description:</strong> ${report.description}</p>` : ''}
              ${report.status ? `<p><strong>Status:</strong> ${report.status}</p>` : ''}
              ${report.priority ? `<p><strong>Priority:</strong> ${report.priority}</p>` : ''}
            </div>
        `;

        if (report.photo_url) {
          popupContent += `
            <div style="margin-top: 12px;">
              <img src="${report.photo_url}" 
                   class="popup-img" 
                   alt="Report photo"
                   onclick="window.open('${report.photo_url}', '_blank')"
                   title="Click to view full size">
              <p style="color: #6b7280; font-size: 11px; margin-top: 4px;">
                Click image to view full size
              </p>
            </div>
          `;
        }
        
        popupContent += `</div>`;

        // Add main report marker
        const marker = L.marker([report.latitude, report.longitude], {
          icon: L.icon({
            iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
          })
        }).addTo(map);
        
        marker.bindPopup(popupContent).openPopup();

        // Add circle around report for better visibility
        L.circle([report.latitude, report.longitude], {
          color: 'red',
          fillColor: '#f03',
          fillOpacity: 0.1,
          radius: 100
        }).addTo(map);

        // Add scale control
        L.control.scale({ imperial: false, position: 'bottomleft' }).addTo(map);

        // Update the page title with location if available
        if (locationName) {
          document.title = `Report at ${locationName.split(',')[0]}`;
        }

      } catch (error) {
        console.error("Error loading report:", error);
        document.getElementById('loading').innerHTML = 
          '<div style="color: red;">Error: ' + error.message + 
          '<br><br><button onclick="location.href=\'notif.html\'">Go Back</button></div>';
      }
    }

    // Load when page is ready
    document.addEventListener('DOMContentLoaded', loadReport);
  </script>
</body>
</html>